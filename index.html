<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>钛白粉供应链管理系统 - 云同步增强版</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body, html { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 1; background: #f1f5f9; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(12px); }
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-hidden { transform: translateX(-100%); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .info-grid { display: grid; grid-template-columns: 80px 1fr; gap: 8px; font-size: 11px; padding-bottom: 4px; }
        .info-label { color: #94a3b8; font-weight: 600; }
        .info-value { color: #334155; }

        #edit-modal { z-index: 3000; }
        input, textarea { border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px 12px; width: 100%; font-size: 13px; background: #f8fafc; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- 状态指示条（移到最前以保证可见性） -->
    <div class="fixed top-6 left-1/2 -translate-x-1/2 z-[5000]">
        <div id="status-bar" class="bg-slate-900/90 backdrop-blur text-white px-6 py-2 rounded-full shadow-2xl flex items-center gap-3">
            <div id="status-dot" class="w-2 h-2 bg-indigo-400 rounded-full animate-ping"></div>
            <span id="status-text" class="text-xs font-bold tracking-wide">初始化系统...</span>
        </div>
    </div>

    <!-- 编辑模态框 -->
    <div id="edit-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-800 flex items-center gap-2">编辑客户信息</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto custom-scroll">
                <input type="hidden" id="edit-id">
                <input type="text" id="edit-name" placeholder="客户名称">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="edit-demand" placeholder="需求量">
                    <input type="text" id="edit-capacity" placeholder="生产产能">
                </div>
                <input type="text" id="edit-supplier" placeholder="主供应商">
                <textarea id="edit-pain" rows="2" placeholder="核心痛点"></textarea>
                <textarea id="edit-remark" rows="2" placeholder="备注信息"></textarea>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="closeEditModal()" class="px-6 py-2 text-xs font-bold text-slate-500">取消</button>
                <button id="save-btn" onclick="saveEdit()" class="px-6 py-2 text-xs font-bold bg-indigo-600 text-white rounded-lg">保存同步</button>
            </div>
        </div>
    </div>

    <div class="flex h-screen relative overflow-hidden">
        <aside id="sidebar" class="w-96 glass-panel border-r border-slate-200 flex flex-col z-[2000] shadow-xl sidebar-transition absolute h-full left-0 top-0">
            <div class="p-6 border-b border-slate-100 bg-white flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-indigo-600 rounded-lg text-white"><i data-lucide="globe" class="w-5 h-5"></i></div>
                    <h1 class="text-base font-bold text-slate-800">钛白粉云系统</h1>
                </div>
                <button id="close-sidebar" class="p-2 text-slate-400"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="px-6 py-4 bg-slate-50/50 border-b flex justify-between">
                    <h2 class="text-xs font-bold text-slate-500">客户清单</h2>
                    <div class="flex gap-2">
                        <button id="export-data" class="text-[10px] text-emerald-600 font-bold">导出</button>
                        <button id="clear-data" class="text-[10px] text-red-400 font-bold">清空</button>
                    </div>
                </div>
                <div id="customer-list" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-3"></div>
            </div>
            <div class="p-6 border-t bg-slate-50/30">
                <div id="drop-zone" class="border-2 border-dashed border-slate-200 rounded-xl p-4 text-center hover:border-indigo-400 cursor-pointer bg-white">
                    <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls, .csv">
                    <i data-lucide="upload-cloud" class="mx-auto w-6 h-6 text-slate-300 mb-1"></i>
                    <p class="text-xs text-slate-600 font-bold">导入 Excel</p>
                </div>
                <div class="mt-4 flex justify-between px-1">
                    <span id="customer-count-label" class="text-[10px] text-slate-400">正在连接数据库...</span>
                </div>
            </div>
        </aside>

        <main class="flex-1 relative h-full w-full">
            <button id="open-sidebar" class="absolute top-6 left-6 z-[1500] bg-white p-3 rounded-xl shadow-xl hidden"><i data-lucide="menu" class="w-6 h-6 text-indigo-600"></i></button>
            <div id="map"></div>
        </main>
    </div>

    <!-- Firebase SDK Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        async function init() {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'titanium-default';
                const dataCollection = collection(db, 'artifacts', appId, 'public', 'data', 'customers');

                window.dbTools = { db, dataCollection, doc, setDoc, deleteDoc, updateDoc, onSnapshot };

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        updateStatus("云同步已激活", false);
                        if (window.startRealtimeSync) window.startRealtimeSync();
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error(err);
                updateStatus("无法连接云端 (网络阻断)", true);
            }
        }

        function updateStatus(text, isError) {
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');
            statusText.textContent = text;
            if (isError) {
                statusDot.classList.remove('bg-indigo-400', 'animate-ping');
                statusDot.classList.add('bg-red-500');
            } else {
                setTimeout(() => document.getElementById('status-bar').parentElement.classList.add('hidden'), 3000);
            }
        }

        init();
    </script>

    <script>
        lucide.createIcons();
        let globalData = [];
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([35.0, 105.0], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        const markersLayer = L.layerGroup().addTo(map);

        const sidebar = document.getElementById('sidebar');
        const openBtn = document.getElementById('open-sidebar');
        const closeBtn = document.getElementById('close-sidebar');

        function toggleSidebar(show) {
            if (show) { sidebar.classList.remove('sidebar-hidden'); openBtn.classList.add('hidden'); }
            else { sidebar.classList.add('sidebar-hidden'); openBtn.classList.remove('hidden'); }
        }
        closeBtn.onclick = () => toggleSidebar(false);
        openBtn.onclick = () => toggleSidebar(true);

        // 实时同步启动函数
        window.startRealtimeSync = function() {
            const { dataCollection, onSnapshot } = window.dbTools;
            onSnapshot(dataCollection, (snapshot) => {
                globalData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderData();
            }, (err) => {
                console.error("Sync Error:", err);
            });
        };

        // 数据渲染
        function renderData() {
            markersLayer.clearLayers();
            const list = document.getElementById('customer-list');
            list.innerHTML = '';
            
            globalData.forEach((c, idx) => {
                const marker = L.circleMarker([c.lat, c.lng], {
                    radius: Math.sqrt(c.demand || 10) + 2,
                    fillColor: '#4f46e5',
                    color: '#fff',
                    weight: 1,
                    fillOpacity: 0.7
                }).addTo(markersLayer);

                marker.bindPopup(`<div class="p-2 font-bold">${c.name}<br><span class="text-indigo-600">${c.demand}吨</span></div>`);

                const card = document.createElement('div');
                card.className = "p-3 bg-white border rounded-xl hover:border-indigo-400 cursor-pointer transition-all";
                card.innerHTML = `<div class="text-sm font-bold truncate">${c.name}</div><div class="text-[10px] text-slate-400">${c.demand}T · ${c.supplier}</div>`;
                card.onclick = () => { map.flyTo([c.lat, c.lng], 10); marker.openPopup(); };
                list.appendChild(card);
            });
            document.getElementById('customer-count-label').textContent = `共 ${globalData.length} 个客户节点`;
        }

        // Excel 导入逻辑
        document.getElementById('drop-zone').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = (e) => {
            if (!window.dbTools) { alert("云端尚未连接，请稍候"); return; }
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const workbook = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                const raw = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                const { dataCollection, doc, setDoc } = window.dbTools;
                for (let item of raw) {
                    const lat = parseFloat(item['纬度'] || item['lat']);
                    const lng = parseFloat(item['经度'] || item['lng']);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        await setDoc(doc(dataCollection, `c_${Date.now()}_${Math.random().toString(36).substr(2,4)}`), {
                            name: item['客户名称'] || item['单位'] || '未知客户',
                            lat, lng,
                            demand: parseFloat(item['需求'] || item['demand']) || 0,
                            supplier: item['供应商'] || '未记录',
                            updateTime: new Date().toLocaleString()
                        });
                    }
                }
                alert("导入成功并已同步云端");
            };
            reader.readAsArrayBuffer(file);
        };

        function openEditModal(id) { /* 同上逻辑 */ }
        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
    </script>
</body>
</html>